(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[694],{1907:(e,s,t)=>{"use strict";t.d(s,{ToastProvider:()=>u,d:()=>c});var r=t(95155),l=t(12115),a=t(42529),i=t(6132),n=t(23327),d=t(65229);let o=(0,l.createContext)({showToast:()=>{},hideToast:()=>{}}),c=()=>{let e=(0,l.useContext)(o);if(!e)throw Error("useToast must be used within a ToastProvider");return e};function u(e){let{children:s}=e,[t,a]=(0,l.useState)([]),i=(0,l.useCallback)(e=>{let s="toast-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),t={id:s,duration:5e3,...e};a(e=>[...e,t]),t.duration&&t.duration>0&&setTimeout(()=>{n(s)},t.duration)},[]),n=(0,l.useCallback)(e=>{a(s=>s.filter(s=>s.id!==e))},[]);return(0,r.jsxs)(o.Provider,{value:{showToast:i,hideToast:n},children:[s,(0,r.jsx)(m,{toasts:t,onHide:n})]})}function m(e){let{toasts:s,onHide:t}=e;return 0===s.length?null:(0,r.jsx)("div",{className:"fixed top-4 right-4 z-50 space-y-2 max-w-sm w-full",children:s.map(e=>(0,r.jsx)(x,{toast:e,onHide:t},e.id))})}function x(e){let{toast:s,onHide:t}=e,[o,c]=(0,l.useState)(!1);return(0,l.useEffect)(()=>{setTimeout(()=>c(!0),10)},[]),(0,r.jsx)("div",{className:"".concat((()=>{let e="p-4 rounded-card shadow-card-hover border-l-4 transition-all duration-300 transform";switch(s.type){case"success":return"".concat(e," bg-green-50 border-green-400 text-green-800");case"error":return"".concat(e," bg-red-50 border-red-400 text-red-800");case"warning":return"".concat(e," bg-yellow-50 border-yellow-400 text-yellow-800");case"info":return"".concat(e," bg-blue-50 border-blue-400 text-blue-800");default:return"".concat(e," bg-gray-50 border-gray-400 text-gray-800")}})()," ").concat(o?"opacity-100 translate-x-0":"opacity-0 translate-x-full"),children:(0,r.jsxs)("div",{className:"flex items-start justify-between",children:[(0,r.jsxs)("div",{className:"flex items-start space-x-3",children:[(()=>{let e="h-5 w-5 mt-0.5";switch(s.type){case"success":return(0,r.jsx)(a.A,{className:"".concat(e," text-green-400")});case"error":return(0,r.jsx)(i.A,{className:"".concat(e," text-red-400")});case"warning":return(0,r.jsx)(i.A,{className:"".concat(e," text-yellow-400")});case"info":return(0,r.jsx)(n.A,{className:"".concat(e," text-blue-400")});default:return(0,r.jsx)(n.A,{className:"".concat(e," text-gray-400")})}})(),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("p",{className:"text-sm font-medium",children:s.title}),s.message&&(0,r.jsx)("p",{className:"text-sm mt-1 opacity-90",children:s.message})]})]}),(0,r.jsx)("button",{onClick:()=>{c(!1),setTimeout(()=>t(s.id),300)},className:"ml-3 text-gray-400 hover:text-gray-600 transition-colors duration-200","aria-label":"Close notification",children:(0,r.jsx)(d.A,{className:"h-4 w-4"})})]})})}},82210:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>x});var r=t(95155),l=t(12115),a=t(7685),i=t(70896),n=t(30337);function d(e){let{onScan:s,onError:t,isActive:a}=e,d=(0,l.useRef)(null),[o,c]=(0,l.useState)(null),[u,m]=(0,l.useState)(null),[x,b]=(0,l.useState)(""),[h,g]=(0,l.useState)(!1),[p,j]=(0,l.useState)(null);(0,l.useEffect)(()=>(a&&!o&&c(new i.sx),()=>{u&&u.stop()}),[a,o,u]),(0,l.useEffect)(()=>{a&&o&&d.current?f():!a&&u&&(u.stop(),m(null))},[a,o]);let f=(0,n.uL)(async()=>{if(o&&d.current){j(null);try{(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach(e=>e.stop())}catch(s){let e=n.zc.handleCameraError(s);j(e.userMessage),null==t||t(e.userMessage),g(!0);return}m(await o.decodeFromVideoDevice(void 0,d.current,(e,t)=>{e&&s(e.getText()),t&&"NotFoundException"!==t.name&&"NotFoundException"!==t.name&&console.warn("Scan processing error:",t)}))}},"QRScanner.startScanning",e=>{j(e.userMessage),null==t||t(e.userMessage),g(!0)});return a?(0,r.jsxs)("div",{className:"flex flex-col items-center space-y-4",children:[(0,r.jsxs)("div",{className:"relative w-full max-w-md",children:[(0,r.jsx)("video",{ref:d,className:"w-full h-64 bg-black rounded-lg object-cover",playsInline:!0}),(0,r.jsxs)("div",{className:"absolute inset-0 border-2 border-umbrella-blue rounded-lg pointer-events-none",children:[(0,r.jsx)("div",{className:"absolute top-4 left-4 w-6 h-6 border-t-4 border-l-4 border-white rounded-tl-lg"}),(0,r.jsx)("div",{className:"absolute top-4 right-4 w-6 h-6 border-t-4 border-r-4 border-white rounded-tr-lg"}),(0,r.jsx)("div",{className:"absolute bottom-4 left-4 w-6 h-6 border-b-4 border-l-4 border-white rounded-bl-lg"}),(0,r.jsx)("div",{className:"absolute bottom-4 right-4 w-6 h-6 border-b-4 border-r-4 border-white rounded-br-lg"})]}),(0,r.jsx)("div",{className:"absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-center py-2 rounded-b-lg",children:(0,r.jsx)("p",{className:"text-sm",children:"QRコードをカメラに向けてください"})})]}),p&&(0,r.jsx)("div",{className:"w-full max-w-md bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:(0,r.jsx)("p",{className:"text-sm",children:p})}),(0,r.jsx)("button",{onClick:()=>g(!h),className:"text-umbrella-blue hover:text-blue-700 underline text-sm",children:h?"カメラスキャンに戻る":"手動でQRコードを入力"}),h&&(0,r.jsxs)("form",{onSubmit:e=>{e.preventDefault(),x.trim()&&(s(x.trim()),b(""),g(!1))},className:"w-full max-w-md space-y-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"manual-qr",className:"block text-sm font-medium text-gray-700 mb-1",children:"QRコード内容を入力"}),(0,r.jsx)("input",{id:"manual-qr",type:"text",value:x,onChange:e=>b(e.target.value),placeholder:"machikasa://umbrella/umb-001",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-umbrella-blue focus:border-transparent"})]}),(0,r.jsx)("button",{type:"submit",disabled:!x.trim(),className:"w-full bg-umbrella-blue text-white py-2 px-4 rounded-md hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors duration-200",children:"スキャン実行"})]}),(0,r.jsx)("div",{className:"w-full max-w-md",children:(0,r.jsxs)("details",{className:"bg-gray-50 p-4 rounded-lg",children:[(0,r.jsx)("summary",{className:"cursor-pointer text-sm font-medium text-gray-700 mb-2",children:"\uD83D\uDCF1 デモ用QRコード"}),(0,r.jsxs)("div",{className:"space-y-2 text-xs",children:[(0,r.jsx)("button",{onClick:()=>s("machikasa://umbrella/umb-001"),className:"block w-full text-left p-2 bg-white rounded border hover:bg-gray-50",children:"\uD83C\uDD94 umb-001 (福井大学正門・利用可能)"}),(0,r.jsx)("button",{onClick:()=>s("machikasa://umbrella/umb-007"),className:"block w-full text-left p-2 bg-white rounded border hover:bg-gray-50",children:"\uD83C\uDD94 umb-007 (ローソン福井大学店・利用可能)"}),(0,r.jsx)("button",{onClick:()=>s("machikasa://umbrella/umb-006"),className:"block w-full text-left p-2 bg-white rounded border hover:bg-gray-50",children:"\uD83C\uDD94 umb-006 (使用中の傘・返却テスト用)"})]})]})})]}):null}var o=t(1907),c=t(82816),u=t(81834),m=t(25016);function x(){let[e,s]=(0,l.useState)(null),[t,i]=(0,l.useState)(null),[n,x]=(0,l.useState)(null),[b,h]=(0,l.useState)(!1),[g,p]=(0,l.useState)(!1),{showToast:j}=(0,o.d)(),{isVisible:f,messageType:y,customMessage:v,showMessage:N,hideMessage:w}=(0,c.K)(),{isVisible:D,messageType:C,customMessage:k,showMessage:R,hideMessage:S}=(0,u.h)();(0,l.useEffect)(()=>{a.I.initialize(),s(a.I.getCurrentUser())},[]);let Q=async()=>{if(t&&e){if("available"!==t.status)return void j({type:"warning",title:"操作無効",message:"この傘は現在借りることができません。"});p(!0);try{await new Promise(e=>setTimeout(e,1e3));let r=a.I.borrowUmbrella(t.id,e.id);r.success?(R("borrow"),setTimeout(()=>{j({type:"success",title:"借用完了 ☂️",message:"雨の日も安心です。返却をお忘れなく！"})},3800),s(a.I.getCurrentUser()),i(a.I.getUmbrella(t.id))):j({type:"error",title:"貸出エラー",message:r.message})}catch(e){console.error("Borrow error:",e),j({type:"error",title:"予期しないエラー",message:"貸出処理中にエラーが発生しました。再度お試しください。"})}finally{p(!1)}}},T=async()=>{if(t&&e){if("available"===t.status)return void j({type:"warning",title:"重複返却",message:"この傘はすでに返却されています。"});if(t.borrowedBy!==e.id)return void j({type:"error",title:"返却権限なし",message:"この傘を返却する権限がありません。"});p(!0);try{await new Promise(e=>setTimeout(e,1e3));let r=a.I.returnUmbrella(t.id,e.id);r.success?(R("return"),setTimeout(()=>{let e=(0,m.pK)(),s=r.points?"".concat(e," +").concat(r.points,"pt獲得！"):e;j({type:"success",title:"返却完了！",message:s})},3800),s(a.I.getCurrentUser()),i(a.I.getUmbrella(t.id))):j({type:"error",title:"返却エラー",message:r.message})}catch(e){console.error("Return error:",e),j({type:"error",title:"予期しないエラー",message:"返却処理中にエラーが発生しました。再度お試しください。"})}finally{p(!1)}}},M=(null==t?void 0:t.status)==="available",E=(null==t?void 0:t.status)==="in_use"&&(null==t?void 0:t.borrowedBy)===(null==e?void 0:e.id);return(0,r.jsxs)("div",{className:"bg-gray-50 min-h-screen",children:[(0,r.jsx)("div",{className:"md:pt-16 bg-white border-b border-gray-200",children:(0,r.jsx)("div",{className:"px-4 py-4 md:px-6",children:(0,r.jsx)("h1",{className:"text-xl md:text-2xl font-bold text-gray-900",children:"\uD83D\uDCF1 QRスキャン"})})}),e&&(0,r.jsx)("div",{className:"bg-white border-b border-gray-200 px-4 py-3 md:hidden",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"font-medium text-sm",children:e.nameJa}),(0,r.jsxs)("p",{className:"text-xs text-gray-600",children:[e.points,"pt・借用",e.totalBorrows,"回・返却",e.totalReturns,"回"]})]}),(0,r.jsx)("div",{className:"text-lg",children:"\uD83D\uDC64"})]})}),t?(0,r.jsxs)("div",{className:"px-4 py-6",children:[(0,r.jsxs)("div",{className:"text-center mb-6",children:[(0,r.jsx)("div",{className:"w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse",children:(0,r.jsx)("span",{className:"text-3xl text-white",children:"✅"})}),(0,r.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"スキャン完了！"}),(0,r.jsx)("p",{className:"text-green-600 font-medium",children:"傘の情報を取得しました"})]}),(0,r.jsxs)("div",{className:"bg-white rounded-xl p-6 shadow-sm border border-gray-200 mx-4 mb-6",children:[(0,r.jsxs)("div",{className:"flex justify-between items-start mb-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("h3",{className:"text-xl font-semibold text-gray-900",children:["傘 ",t.id]}),(0,r.jsxs)("p",{className:"text-sm text-gray-600 mt-1",children:["ステーション: ",null==n?void 0:n.nameJa]})]}),(0,r.jsx)("div",{className:"px-3 py-1 rounded-full text-sm font-medium ".concat("available"===t.status?"bg-green-100 text-green-800":"in_use"===t.status?"bg-blue-100 text-blue-800":"bg-orange-100 text-orange-800"),children:(0,m.VB)(t.status)})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm mb-6",children:[(0,r.jsxs)("div",{className:"bg-gray-50 rounded-lg p-3",children:[(0,r.jsx)("span",{className:"text-gray-600 block text-xs",children:"状態"}),(0,r.jsx)("span",{className:"font-medium text-gray-900",children:(0,m.KB)(t.condition)})]}),t.batteryLevel&&(0,r.jsxs)("div",{className:"bg-gray-50 rounded-lg p-3",children:[(0,r.jsx)("span",{className:"text-gray-600 block text-xs",children:"バッテリー"}),(0,r.jsxs)("span",{className:"font-medium text-gray-900",children:["\uD83D\uDD0B ",t.batteryLevel,"%"]})]})]}),(0,r.jsxs)("div",{className:"space-y-4",children:[M&&(0,r.jsx)("button",{onClick:Q,disabled:g,className:"w-full bg-green-500 hover:bg-green-600 disabled:bg-gray-300 text-white py-4 px-6 rounded-xl text-lg font-semibold transform hover:scale-[1.02] transition-all duration-200 disabled:transform-none",children:g?(0,r.jsxs)("span",{className:"flex items-center justify-center",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3"}),"処理中..."]}):"\uD83D\uDE80 この傘を借りる"}),E&&(0,r.jsx)("button",{onClick:T,disabled:g,className:"w-full bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white py-4 px-6 rounded-xl text-lg font-semibold transform hover:scale-[1.02] transition-all duration-200 disabled:transform-none",children:g?(0,r.jsxs)("span",{className:"flex items-center justify-center",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3"}),"処理中..."]}):"✅ この傘を返却する"}),!M&&!E&&(0,r.jsxs)("div",{className:"text-center py-8",children:[(0,r.jsx)("div",{className:"text-4xl mb-4",children:"⚠️"}),(0,r.jsx)("p",{className:"text-gray-600 mb-2 font-medium",children:"in_use"===t.status?"別のユーザーが使用中です":"この傘は現在利用できません"}),"maintenance"===t.status&&(0,r.jsx)("p",{className:"text-sm text-orange-600",children:"メンテナンス中のため利用できません"})]}),(0,r.jsx)("button",{onClick:()=>{i(null),x(null),h(!0)},className:"w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 px-6 rounded-xl font-medium transition-colors",children:"\uD83D\uDD04 別の傘をスキャン"})]})]})]}):(0,r.jsxs)("div",{className:"relative",children:[b?(0,r.jsxs)("div",{className:"relative h-[70vh] md:h-96",children:[(0,r.jsx)(d,{isActive:b,onScan:e=>{if(console.log("Scanned QR:",e),!(0,m.w7)(e))return void j({type:"error",title:"無効なQRコード",message:"Machikasa専用のQRコードをスキャンしてください。"});let s=(0,m.Xw)(e);if(!s)return void j({type:"error",title:"QRコード読み取りエラー",message:"QRコードから傘IDを取得できませんでした。"});let t=a.I.getUmbrella(s);if(!t)return void j({type:"error",title:"傘が見つかりません",message:"QRコードを再確認してください。"});let r=a.I.getStation(t.stationId);i(t),x(r),h(!1),j({type:"info",title:"スキャン完了",message:"傘の情報を取得しました。"})},onError:e=>{j({type:"error",title:"スキャンエラー",message:e}),h(!1)}}),(0,r.jsx)("div",{className:"absolute bottom-6 left-1/2 transform -translate-x-1/2",children:(0,r.jsx)("button",{onClick:()=>h(!1),className:"bg-white/90 backdrop-blur-sm text-gray-800 px-6 py-3 rounded-full font-medium hover:bg-white transition-all",children:"✕ スキャン停止"})}),(0,r.jsx)("div",{className:"absolute top-6 left-1/2 transform -translate-x-1/2",children:(0,r.jsx)("div",{className:"bg-blue-500/90 backdrop-blur-sm text-white px-4 py-2 rounded-full text-sm font-medium",children:"\uD83D\uDD0D QRコードを探しています..."})})]}):(0,r.jsx)("div",{className:"h-[70vh] md:h-96 flex flex-col items-center justify-center bg-gray-900 text-white",children:(0,r.jsxs)("div",{className:"text-center px-6",children:[(0,r.jsx)("div",{className:"text-8xl md:text-6xl mb-6",children:"\uD83D\uDCF7"}),(0,r.jsx)("h2",{className:"text-2xl md:text-xl font-semibold mb-4",children:"傘のQRコードをスキャン"}),(0,r.jsx)("p",{className:"text-gray-300 mb-8 text-sm md:text-base",children:"傘に付いているQRコードをカメラに向けてください"}),(0,r.jsx)("button",{onClick:()=>h(!0),className:"w-full max-w-xs bg-blue-500 hover:bg-blue-600 text-white py-4 px-8 rounded-xl text-lg font-semibold transform hover:scale-105 transition-all duration-200",children:"\uD83D\uDCF1 スキャン開始"})]})}),!b&&(0,r.jsx)("div",{className:"px-4 py-6",children:(0,r.jsxs)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[(0,r.jsx)("h3",{className:"font-semibold text-blue-900 mb-2 text-sm",children:"\uD83D\uDCA1 スキャンのコツ"}),(0,r.jsxs)("ul",{className:"text-blue-800 text-xs space-y-1",children:[(0,r.jsx)("li",{children:"• QRコードを画面中央に合わせてください"}),(0,r.jsx)("li",{children:"• 十分な明るさがある場所で行ってください"}),(0,r.jsx)("li",{children:"• コードから20-30cm離してスキャンしてください"})]})]})})]}),e&&(0,r.jsx)("div",{className:"hidden md:block bg-white mx-4 rounded-lg p-4 shadow-sm border border-gray-200 mb-6",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"font-medium",children:e.nameJa}),(0,r.jsxs)("p",{className:"text-sm text-gray-600",children:["ポイント: ",e.points,"pt | 貸出: ",e.totalBorrows,"回 | 返却: ",e.totalReturns,"回"]})]}),(0,r.jsx)("div",{className:"text-2xl",children:"\uD83D\uDC64"})]})}),!b&&(0,r.jsxs)("div",{className:"hidden md:block mx-4 bg-blue-50 border border-blue-200 rounded-lg p-6",children:[(0,r.jsx)("h3",{className:"font-semibold text-blue-900 mb-2",children:"\uD83D\uDCF1 使い方のヒント"}),(0,r.jsxs)("ul",{className:"text-blue-800 text-sm space-y-1",children:[(0,r.jsx)("li",{children:"• 傘に付いているQRコードをカメラに向けてください"}),(0,r.jsx)("li",{children:"• 十分な明るさがある場所で行ってください"}),(0,r.jsx)("li",{children:"• QRコードから適切な距離を保ってください"}),(0,r.jsx)("li",{children:"• 傘の返却でポイントがもらえます"})]})]}),(0,r.jsx)(u.A,{isVisible:D,onComplete:S,type:C,customMessage:k}),(0,r.jsx)(c.A,{isVisible:f,onComplete:w,type:y,customMessage:v})]})}},89268:(e,s,t)=>{Promise.resolve().then(t.bind(t,82210))}},e=>{e.O(0,[619,685,20,441,493,358],()=>e(e.s=89268)),_N_E=e.O()}]);