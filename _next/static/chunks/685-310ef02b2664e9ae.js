"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[685],{7685:(t,e,a)=>{a.d(e,{I:()=>m});let s=[{id:"station-1",name:"Fukui University Main Gate",nameJa:"福井大学正門",location:{lat:36.0668,lng:136.2189},address:"3-9-1 Bunkyo, Fukui City, Fukui",addressJa:"福井県福井市文京3-9-1",capacity:8,currentCount:5,type:"university",operatingHours:{open:"06:00",close:"22:00"},isActive:!0,contactInfo:{phone:"0776-27-8001"}},{id:"station-2",name:"Lawson Fukui University Store",nameJa:"ローソン福井大学店",location:{lat:36.0655,lng:136.2175},address:"2-8-15 Bunkyo, Fukui City, Fukui",addressJa:"福井県福井市文京2-8-15",capacity:6,currentCount:3,type:"store",operatingHours:{open:"24:00",close:"24:00"},isActive:!0,contactInfo:{phone:"0776-25-1234"}},{id:"station-3",name:"Fukui Station East Exit",nameJa:"JR福井駅東口",location:{lat:36.0616,lng:136.2237},address:"1-1-1 Chuo, Fukui City, Fukui",addressJa:"福井県福井市中央1-1-1",capacity:12,currentCount:8,type:"public",operatingHours:{open:"05:00",close:"24:00"},isActive:!0,contactInfo:{phone:"0776-20-0541"}}],r=[{id:"umb-001",code:"machikasa://umbrella/umb-001",qrCode:"machikasa://umbrella/umb-001",status:"available",stationId:"station-1",lastUpdated:"2025-10-12T08:00:00Z",condition:"good",batteryLevel:95},{id:"umb-002",code:"machikasa://umbrella/umb-002",qrCode:"machikasa://umbrella/umb-002",status:"available",stationId:"station-1",lastUpdated:"2025-10-12T08:00:00Z",condition:"good",batteryLevel:88},{id:"umb-003",code:"machikasa://umbrella/umb-003",qrCode:"machikasa://umbrella/umb-003",status:"available",stationId:"station-1",lastUpdated:"2025-10-12T08:00:00Z",condition:"fair",batteryLevel:72},{id:"umb-004",code:"machikasa://umbrella/umb-004",qrCode:"machikasa://umbrella/umb-004",status:"available",stationId:"station-1",lastUpdated:"2025-10-12T08:00:00Z",condition:"good",batteryLevel:100},{id:"umb-005",code:"machikasa://umbrella/umb-005",qrCode:"machikasa://umbrella/umb-005",status:"available",stationId:"station-1",lastUpdated:"2025-10-12T08:00:00Z",condition:"good",batteryLevel:91},{id:"umb-006",code:"machikasa://umbrella/umb-006",qrCode:"machikasa://umbrella/umb-006",status:"in_use",stationId:"station-1",lastUpdated:"2025-10-12T09:30:00Z",condition:"good",batteryLevel:85,borrowedBy:"user-1"},{id:"umb-007",code:"machikasa://umbrella/umb-007",qrCode:"machikasa://umbrella/umb-007",status:"available",stationId:"station-2",lastUpdated:"2025-10-12T08:00:00Z",condition:"good",batteryLevel:93},{id:"umb-008",code:"machikasa://umbrella/umb-008",qrCode:"machikasa://umbrella/umb-008",status:"available",stationId:"station-2",lastUpdated:"2025-10-12T08:00:00Z",condition:"fair",batteryLevel:67},{id:"umb-009",code:"machikasa://umbrella/umb-009",qrCode:"machikasa://umbrella/umb-009",status:"available",stationId:"station-2",lastUpdated:"2025-10-12T08:00:00Z",condition:"good",batteryLevel:98},{id:"umb-010",code:"machikasa://umbrella/umb-010",qrCode:"machikasa://umbrella/umb-010",status:"in_use",stationId:"station-2",lastUpdated:"2025-10-12T10:15:00Z",condition:"good",batteryLevel:82,borrowedBy:"user-2"},{id:"umb-011",code:"machikasa://umbrella/umb-011",qrCode:"machikasa://umbrella/umb-011",status:"available",stationId:"station-3",lastUpdated:"2025-10-12T08:00:00Z",condition:"good",batteryLevel:89},{id:"umb-012",code:"machikasa://umbrella/umb-012",qrCode:"machikasa://umbrella/umb-012",status:"available",stationId:"station-3",lastUpdated:"2025-10-12T08:00:00Z",condition:"good",batteryLevel:96},{id:"umb-013",code:"machikasa://umbrella/umb-013",qrCode:"machikasa://umbrella/umb-013",status:"maintenance",stationId:"station-3",lastUpdated:"2025-10-11T16:30:00Z",condition:"poor",batteryLevel:45}],i=[{id:"user-1",name:"Takeshi Yamada",nameJa:"山田武志",email:"yamada@fukui-u.ac.jp",role:"student",studentId:"FU2023001",department:"Engineering",phone:"090-1234-5678",totalBorrows:15,totalReturns:14,points:280,isActive:!0,createdAt:"2025-04-01T00:00:00Z",lastLoginAt:"2025-10-12T09:30:00Z"},{id:"user-2",name:"Yuki Tanaka",nameJa:"田中雪",email:"tanaka@fukui-u.ac.jp",role:"student",studentId:"FU2024002",department:"Liberal Arts",phone:"090-2345-6789",totalBorrows:8,totalReturns:8,points:160,isActive:!0,createdAt:"2025-04-15T00:00:00Z",lastLoginAt:"2025-10-12T10:15:00Z"},{id:"user-admin",name:"Kensuke Sato",nameJa:"佐藤健介",email:"admin@fukui-u.ac.jp",role:"admin",department:"Student Affairs",phone:"0776-27-8100",totalBorrows:0,totalReturns:0,points:0,isActive:!0,createdAt:"2025-01-01T00:00:00Z",lastLoginAt:"2025-10-12T08:00:00Z"}],n=[{id:"tx-001",userId:"user-1",umbrellaId:"umb-006",stationId:"station-1",action:"borrow",timestamp:"2025-10-12T09:30:00Z",location:{lat:36.0668,lng:136.2189},weather:"rainy"},{id:"tx-002",userId:"user-2",umbrellaId:"umb-010",stationId:"station-2",action:"borrow",timestamp:"2025-10-12T10:15:00Z",location:{lat:36.0655,lng:136.2175},weather:"cloudy"},{id:"tx-003",userId:"user-1",umbrellaId:"umb-002",stationId:"station-1",action:"return",timestamp:"2025-10-11T18:45:00Z",location:{lat:36.0668,lng:136.2189},weather:"clear",pointsEarned:20}],o=[{id:"sponsor-1",name:"福井コーヒー",nameEn:"Fukui Coffee",logoUrl:"/Machikasa/sponsors/fukui-coffee.svg",message:"美味しいコーヒーで、雨の日も心温まる時間を。",messageEn:"Warm your heart with delicious coffee, even on rainy days.",websiteUrl:"https://fukui-coffee.local",active:!0,joinedDate:"2025-09-01T00:00:00Z",contactEmail:"info@fukui-coffee.local",category:"local_business"},{id:"sponsor-2",name:"さばえ書店",nameEn:"Sabae Bookstore",logoUrl:"/Machikasa/sponsors/sabae-books.svg",message:"知識と傘で、雨の日も晴れやかに。",messageEn:"Knowledge and umbrellas make rainy days brighter.",active:!0,joinedDate:"2025-09-15T00:00:00Z",category:"local_business"},{id:"sponsor-3",name:"福井大学生協",nameEn:"Fukui University Co-op",logoUrl:"/Machikasa/sponsors/fukui-coop.svg",message:"学生生活をもっと便利に、もっと楽しく。",messageEn:"Making student life more convenient and enjoyable.",active:!0,joinedDate:"2025-08-01T00:00:00Z",category:"university"},{id:"sponsor-4",name:"カフェ未来",nameEn:"Cafe Mirai",logoUrl:"/Machikasa/sponsors/cafe-mirai.svg",message:"未来への一歩は、コーヒー一杯から。",messageEn:"The step towards the future starts with a cup of coffee.",active:!0,joinedDate:"2025-10-01T00:00:00Z",contactEmail:"hello@cafe-mirai.local",category:"local_business"}],l=[{id:"partner-1",name:"Fukui Coffee 文京店",nameEn:"Fukui Coffee Bunkyo Branch",type:"cafe",address:"福井県福井市文京4-1-15",lat:36.0645,lng:136.2175,phone:"0776-25-1234",hours:"7:00-20:00",sponsorId:"sponsor-1",offers:["返却でコーヒー10円引き","ポイント2倍キャンペーン"],availableUmbrellas:3,maxCapacity:6,isActive:!0,joinedDate:"2025-09-01T00:00:00Z",lastUpdated:"2025-10-12T09:00:00Z",features:["umbrella_station","return_bonus","sponsor_benefits","student_discount"]},{id:"partner-2",name:"さばえ書店 福井店",nameEn:"Sabae Bookstore Fukui Branch",type:"bookstore",address:"福井県福井市中央2-8-21",lat:36.0625,lng:136.2145,phone:"0776-24-5678",hours:"9:00-21:00",sponsorId:"sponsor-2",offers:["返却で文具10%引き","学習本ポイント3倍"],availableUmbrellas:5,maxCapacity:8,isActive:!0,joinedDate:"2025-09-15T00:00:00Z",lastUpdated:"2025-10-12T08:30:00Z",features:["umbrella_station","return_bonus","sponsor_benefits","student_discount"]},{id:"partner-3",name:"福井大学生協ストア",nameEn:"Fukui University Co-op Store",type:"convenience",address:"福井県福井市文京3-9-1 福井大学内",lat:36.0672,lng:136.2195,phone:"0776-27-8888",hours:"8:00-19:00",sponsorId:"sponsor-3",offers:["返却で弁当5%引き","文房具ポイント2倍"],availableUmbrellas:8,maxCapacity:12,isActive:!0,joinedDate:"2025-08-20T00:00:00Z",lastUpdated:"2025-10-12T07:45:00Z",features:["umbrella_station","return_bonus","sponsor_benefits","student_discount"]},{id:"partner-4",name:"Cafe Mirai",nameEn:"Cafe Mirai",type:"cafe",address:"福井県福井市順化1-14-7",lat:36.0598,lng:136.2165,phone:"0776-23-9999",hours:"8:00-22:00",sponsorId:"sponsor-4",offers:["返却でドリンク15円引き","ケーキセット特価"],availableUmbrellas:4,maxCapacity:6,isActive:!0,joinedDate:"2025-10-01T00:00:00Z",lastUpdated:"2025-10-12T10:15:00Z",features:["umbrella_station","return_bonus","sponsor_benefits"]},{id:"partner-5",name:"コンビニ文京",nameEn:"Convenience Bunkyo",type:"convenience",address:"福井県福井市文京5-2-8",lat:36.0635,lng:136.2158,phone:"0776-26-7777",hours:"24時間営業",offers:["返却でポイント+2","飲料10円引き"],availableUmbrellas:6,maxCapacity:10,isActive:!0,joinedDate:"2025-09-20T00:00:00Z",lastUpdated:"2025-10-12T06:00:00Z",features:["umbrella_station","return_bonus"]}],c=[{id:"deal-1",sponsorId:"sponsor-1",partnerStoreId:"partner-1",dealType:"points_bonus",description:"Fukui Coffeeでの返却で追加ポイント",value:2,active:!0,startDate:"2025-09-01T00:00:00Z",endDate:"2025-12-31T23:59:59Z"},{id:"deal-2",sponsorId:"sponsor-2",partnerStoreId:"partner-2",dealType:"discount",description:"さばえ書店での文具割引",value:10,active:!0,startDate:"2025-09-15T00:00:00Z",endDate:"2025-11-30T23:59:59Z"},{id:"deal-3",sponsorId:"sponsor-3",partnerStoreId:"partner-3",dealType:"points_bonus",description:"生協ストアでの返却で学生特典",value:3,active:!0,startDate:"2025-08-20T00:00:00Z"}];var u=a(30337);let d={STATIONS:"machikasa_stations",UMBRELLAS:"machikasa_umbrellas",USERS:"machikasa_users",TRANSACTIONS:"machikasa_transactions",SPONSORS:"machikasa_sponsors",PARTNER_STORES:"machikasa_partner_stores",SPONSORSHIP_DEALS:"machikasa_sponsorship_deals",PARTNER_RETURNS:"machikasa_partner_returns",CURRENT_USER:"machikasa_current_user",INITIALIZED:"machikasa_initialized"};class m{static initialize(){(0,u.Uj)(()=>{if(u.Jm.get(d.INITIALIZED,!1))this.verifyDataIntegrity();else{if(!this.validateMockData()){console.warn("Mock data validation failed, using minimal fallback data"),this.initializeWithFallbackData();return}this.setStations(s),this.setUmbrellas(r),this.setUsers(i),this.setTransactions(n),this.setSponsors(o),this.setPartnerStores(l),this.setSponsorshipDeals(c),this.setPartnerReturns([]),this.setCurrentUser(i[0]),u.Jm.set(d.INITIALIZED,!0),console.log("\uD83D\uDE80 LocalDB initialized with mock data")}},"LocalDB.initialize",t=>{console.error("Failed to initialize LocalDB, using fallback data:",t.userMessage),this.initializeWithFallbackData()})()}static validateMockData(){try{return Array.isArray(s)&&s.length>0&&Array.isArray(r)&&r.length>0&&Array.isArray(i)&&i.length>0&&Array.isArray(n)&&Array.isArray(o)&&Array.isArray(l)&&Array.isArray(c)}catch(t){return!1}}static initializeWithFallbackData(){let t={id:"user-fallback",name:"Guest User",nameJa:"ゲストユーザー",email:"guest@example.com",role:"student",points:0,totalBorrows:0,totalReturns:0,isActive:!0,createdAt:new Date().toISOString(),lastLoginAt:new Date().toISOString()},e={id:"umb-fallback",code:"machikasa://umbrella/umb-fallback",qrCode:"machikasa://umbrella/umb-fallback",stationId:"station-fallback",status:"available",condition:"good",batteryLevel:100,lastUpdated:new Date().toISOString()};this.setStations([{id:"station-fallback",name:"Emergency Station",nameJa:"緊急ステーション",location:{lat:36,lng:136},address:"Fukui University",addressJa:"福井大学内",capacity:5,currentCount:1,type:"university",operatingHours:{open:"09:00",close:"21:00"},isActive:!0}]),this.setUmbrellas([e]),this.setUsers([t]),this.setTransactions([]),this.setSponsors([]),this.setPartnerStores([]),this.setSponsorshipDeals([]),this.setPartnerReturns([]),this.setCurrentUser(t),u.Jm.set(d.INITIALIZED,!0),console.log("\uD83C\uDD98 LocalDB initialized with fallback data")}static verifyDataIntegrity(){(0,u.Uj)(()=>{let t=this.getStations(),e=this.getUmbrellas(),a=this.getUsers(),s=this.getCurrentUser();if(!t.length||!e.length||!a.length){console.warn("Essential data missing, reinitializing..."),u.Jm.remove(d.INITIALIZED),this.initialize();return}s&&a.find(t=>t.id===s.id)||(console.warn("Current user invalid, setting default user"),this.setCurrentUser(a[0])),console.log("✅ Data integrity verification passed")},"LocalDB.verifyDataIntegrity",t=>{console.warn("Data integrity check failed, reinitializing:",t.userMessage),u.Jm.remove(d.INITIALIZED),this.initialize()})()}static reset(){Object.values(d).forEach(t=>{localStorage.removeItem(t)}),this.initialize(),console.log("\uD83D\uDD04 LocalDB reset and reinitialized")}static getStations(){return this.getData(d.STATIONS,[])}static setStations(t){this.setData(d.STATIONS,t)}static getStation(t){return this.getStations().find(e=>e.id===t)||null}static updateStationCount(t,e){let a=this.getStations(),s=a.find(e=>e.id===t);s&&(s.currentCount=Math.max(0,Math.min(s.capacity,s.currentCount+e)),this.setStations(a))}static getUmbrellas(){return this.getData(d.UMBRELLAS,[])}static setUmbrellas(t){this.setData(d.UMBRELLAS,t)}static getUmbrella(t){return this.getUmbrellas().find(e=>e.id===t)||null}static getUmbrellaByQR(t){let e=t.match(/machikasa:\/\/umbrella\/(.+)/);return e?this.getUmbrella(e[1]):null}static getAvailableUmbrellas(t){return this.getUmbrellas().filter(e=>"available"===e.status&&(!t||e.stationId===t))}static updateUmbrellaStatus(t,e,a){let s=this.getUmbrellas(),r=s.find(e=>e.id===t);return!!r&&(r.status=e,r.lastUpdated=new Date().toISOString(),"in_use"===e&&a?r.borrowedBy=a:"available"===e&&delete r.borrowedBy,this.setUmbrellas(s),!0)}static getUsers(){return this.getData(d.USERS,[])}static setUsers(t){this.setData(d.USERS,t)}static getUser(t){return this.getUsers().find(e=>e.id===t)||null}static getCurrentUser(){return this.getData(d.CURRENT_USER,null)}static setCurrentUser(t){this.setData(d.CURRENT_USER,t)}static updateUserStats(t,e,a){let s=this.getUsers(),r=s.find(e=>e.id===t);if(!r)return;"borrow"===e?r.totalBorrows++:(r.totalReturns++,a&&(r.points+=a)),r.lastLoginAt=new Date().toISOString(),this.setUsers(s);let i=this.getCurrentUser();i&&i.id===t&&this.setCurrentUser(r)}static getTransactions(){return this.getData(d.TRANSACTIONS,[])}static setTransactions(t){this.setData(d.TRANSACTIONS,t)}static addTransaction(t,e,a,s){let r=this.getTransactions(),i="tx-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),n={id:i,umbrellaId:e,action:t,userId:a,stationId:s,timestamp:new Date().toISOString(),type:t,pointsEarned:"return"===t?1:void 0};return r.push(n),this.setTransactions(r),i}static addTransactionLegacy(t){let e=this.getTransactions(),a="tx-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),s={id:a,...t};return e.push(s),this.setTransactions(e),a}static getUserTransactions(t,e){let a=this.getTransactions().filter(e=>e.userId===t).sort((t,e)=>new Date(e.timestamp).getTime()-new Date(t.timestamp).getTime());return e?a.slice(0,e):a}static getSponsors(){return this.getData(d.SPONSORS,[])}static setSponsors(t){this.setData(d.SPONSORS,t)}static getSponsor(t){return this.getSponsors().find(e=>e.id===t)||null}static getActiveSponsors(){return this.getSponsors().filter(t=>t.active)}static getPartnerStores(){return this.getData(d.PARTNER_STORES,[])}static setPartnerStores(t){this.setData(d.PARTNER_STORES,t)}static getPartnerStore(t){return this.getPartnerStores().find(e=>e.id===t)||null}static getActivePartnerStores(){return this.getPartnerStores().filter(t=>t.isActive)}static getPartnerStoresByType(t){return this.getActivePartnerStores().filter(e=>e.type===t)}static updatePartnerStoreUmbrellas(t,e){let a=this.getPartnerStores(),s=a.find(e=>e.id===t);return!!s&&(s.availableUmbrellas=Math.max(0,Math.min(e,s.maxCapacity)),s.lastUpdated=new Date().toISOString(),this.setPartnerStores(a),!0)}static getSponsorshipDeals(){return this.getData(d.SPONSORSHIP_DEALS,[])}static setSponsorshipDeals(t){this.setData(d.SPONSORSHIP_DEALS,t)}static getActiveDealsByPartnerStore(t){let e=this.getSponsorshipDeals(),a=new Date().toISOString();return e.filter(e=>e.partnerStoreId===t&&e.active&&e.startDate<=a&&(!e.endDate||e.endDate>=a))}static getPartnerReturns(){return this.getData(d.PARTNER_RETURNS,[])}static setPartnerReturns(t){this.setData(d.PARTNER_RETURNS,t)}static addPartnerReturn(t,e,a,s,r,i){let n=this.getPartnerReturns(),o="pr-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),l={id:o,transactionId:e,partnerStoreId:t,userId:a,umbrellaId:s,bonusPoints:r,dealApplied:i,timestamp:new Date().toISOString()};return n.push(l),this.setPartnerReturns(n),o}static returnUmbrellaToPartnerStore(t,e,a){let s,r=this.getUmbrella(t),i=this.getPartnerStore(a),n=this.getUser(e);if(!r)return{success:!1,message:"傘が見つかりません。"};if(!i||!i.isActive)return{success:!1,message:"指定された加盟店は利用できません。"};if(!n)return{success:!1,message:"ユーザーが見つかりません。"};if("in_use"!==r.status||r.borrowedBy!==e)return{success:!1,message:"この傘は返却できません。"};if(i.availableUmbrellas>=i.maxCapacity)return{success:!1,message:"この店舗は満員です。別の場所に返却してください。"};let o=this.getActiveDealsByPartnerStore(a),l=1,c=o.filter(t=>"points_bonus"===t.dealType).sort((t,e)=>e.value-t.value)[0];c&&(l=c.value,s=c.description),r.status="available",r.stationId=a,delete r.borrowedBy,r.lastUpdated=new Date().toISOString(),this.updatePartnerStoreUmbrellas(a,i.availableUmbrellas+1);let u=this.addTransaction("return",t,e,a);this.addPartnerReturn(a,u,e,t,l,s),this.updateUserStats(e,"return",l),this.addUserPoints(e,l);let d=this.getUmbrellas(),m=d.findIndex(e=>e.id===t);return -1!==m&&(d[m]=r,this.setUmbrellas(d)),{success:!0,message:s?"".concat(i.name,"で返却完了！").concat(s,"が適用されました。"):"".concat(i.name,"で返却完了！"),points:l,dealApplied:s}}static getData(t,e){let a=u.Jm.get(t,e);return(0,u.e_)(a,e)}static setData(t,e){u.Jm.set(t,e)||console.warn("Failed to save data for key: ".concat(t))}static borrowUmbrella(t,e){let a=this.getUmbrella(t);return a?"in_use"===a.status?{success:!1,message:"この傘は使用中です。"}:"available"!==a.status?{success:!1,message:"この傘は現在利用できません。"}:(this.updateUmbrellaStatus(t,"in_use",e),this.updateStationCount(a.stationId,-1),this.updateUserStats(e,"borrow"),this.addTransaction("borrow",t,e,a.stationId),{success:!0,message:"傘の貸出が完了しました！",umbrella:this.getUmbrella(t)||void 0}):{success:!1,message:"傘情報が見つかりませんでした。"}}static returnUmbrella(t,e){let a=this.getUmbrella(t);return a?"available"===a.status?{success:!1,message:"この傘はすでに返却されています。"}:"in_use"!==a.status||a.borrowedBy!==e?{success:!1,message:"この傘の返却権限がありません。"}:(this.updateUmbrellaStatus(t,"available"),this.updateStationCount(a.stationId,1),this.updateUserStats(e,"return"),this.addUserPoints(e,1),this.addTransaction("return",t,e,a.stationId),{success:!0,message:"あなたの返却で1ポイント獲得しました！",points:1,umbrella:this.getUmbrella(t)||void 0}):{success:!1,message:"傘情報が見つかりませんでした。"}}static getUserPoints(t){let e=this.getUser(t);return e?e.points:0}static addUserPoints(t,e){let a=this.getUsers(),s=a.find(e=>e.id===t);if(s){s.points+=e,this.setUsers(a);let r=this.getCurrentUser();r&&r.id===t&&this.setCurrentUser(s)}}static getTransactionStats(){let t=this.getTransactions(),e=this.getStations(),a=t.filter(t=>"borrow"===t.action).length,s=t.filter(t=>"return"===t.action).length,r=Array.from({length:7},(t,e)=>{let a=new Date;return a.setDate(a.getDate()-e),a.toISOString().split("T")[0]}).reverse().map(e=>{let a=t.filter(t=>t.timestamp.startsWith(e));return{date:e,count:a.length,borrows:a.filter(t=>"borrow"===t.action).length,returns:a.filter(t=>"return"===t.action).length}}),i=e.map(e=>{let a=t.filter(t=>t.stationId===e.id),s=a.filter(t=>"borrow"===t.action).length,r=a.filter(t=>"return"===t.action).length;return{stationId:e.id,stationName:e.nameJa,borrows:s,returns:r,total:s+r}}).sort((t,e)=>e.total-t.total);return{total:t.length,borrowCount:a,returnCount:s,returnRate:Math.round(100*(a>0?s/a*100:0))/100,daily:r,byStation:i}}static getUmbrellaStatusDistribution(){let t=this.getUmbrellas();return{available:t.filter(t=>"available"===t.status).length,inUse:t.filter(t=>"in_use"===t.status).length,maintenance:t.filter(t=>"maintenance"===t.status).length,lost:t.filter(t=>"lost"===t.status).length}}static getStationUtilization(){let t=this.getStations(),e=this.getUmbrellas(),a=this.getTransactions();return t.map(t=>{let s=e.filter(e=>e.stationId===t.id),r=a.filter(e=>e.stationId===t.id),i=s.length>0?r.length/s.length*10:0;return{stationId:t.id,stationName:t.nameJa,totalUmbrellas:s.length,utilizationRate:Math.round(100*i)/100,totalTransactions:r.length}})}static exportTransactionsToCSV(){let t=this.getTransactions(),e=this.getStations(),a=this.getUsers(),s=new Map(e.map(t=>[t.id,t.nameJa])),r=new Map(a.map(t=>[t.id,t.nameJa]));return[["transaction_id","umbrella_id","action","user_id","user_name","station_id","station_name","points_earned","timestamp","date_formatted"],...t.map(t=>{let e=s.get(t.stationId)||"Unknown Station",a=r.get(t.userId)||"Unknown User",i=new Intl.DateTimeFormat("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(new Date(t.timestamp));return[t.id,t.umbrellaId,t.action,t.userId,a,t.stationId,e,t.pointsEarned||0,t.timestamp,i]})].map(t=>t.map(t=>'"'.concat(t,'"')).join(",")).join("\n")}static downloadTransactionsCSV(){let t=new Blob([this.exportTransactionsToCSV()],{type:"text/csv;charset=utf-8;"}),e=document.createElement("a");if(void 0!==e.download){let a=URL.createObjectURL(t);e.setAttribute("href",a);let s=new Date().toISOString().split("T")[0];e.setAttribute("download","machikasa_transactions_".concat(s,".csv")),e.style.visibility="hidden",document.body.appendChild(e),e.click(),document.body.removeChild(e)}}static getAdminSummary(){let t=this.getUmbrellas(),e=this.getStations(),a=this.getTransactions(),s=a.filter(t=>"borrow"===t.action).length,r=a.filter(t=>"return"===t.action).length,i=new Map;a.forEach(t=>{i.set(t.stationId,(i.get(t.stationId)||0)+1)});let n=Array.from(i.entries()).map(t=>{let[a,s]=t,r=e.find(t=>t.id===a);return{name:(null==r?void 0:r.nameJa)||"Unknown",transactions:s}}).sort((t,e)=>e.transactions-t.transactions).slice(0,3),o=Object.entries({available:t.filter(t=>"available"===t.status).length,in_use:t.filter(t=>"in_use"===t.status).length,maintenance:t.filter(t=>"maintenance"===t.status).length,lost:t.filter(t=>"lost"===t.status).length}).map(e=>{let[a,s]=e;return{status:a,count:s,percentage:t.length>0?Math.round(s/t.length*100):0}});return{totalUmbrellas:t.length,activeStations:i.size,totalTransactions:a.length,returnRate:Math.round(100*(s>0?r/s*100:0))/100,topStations:n,umbrellasByStatus:o}}static borrowUmbrellaLegacy(t,e,a){let s=this.borrowUmbrella(t,e);return{success:s.success,message:s.message}}static returnUmbrellaLegacy(t,e,a){let s=this.returnUmbrella(t,e);return{success:s.success,message:s.message,points:s.points}}}},30337:(t,e,a)=>{a.d(e,{Jm:()=>c,Uj:()=>n,e_:()=>l,uL:()=>o,zc:()=>i});let s={CAMERA_ACCESS_DENIED:"CAMERA_ACCESS_DENIED",CAMERA_NOT_AVAILABLE:"CAMERA_NOT_AVAILABLE",CAMERA_HARDWARE_ERROR:"CAMERA_HARDWARE_ERROR",QR_SCAN_FAILED:"QR_SCAN_FAILED",STORAGE_QUOTA_EXCEEDED:"STORAGE_QUOTA_EXCEEDED",STORAGE_ACCESS_DENIED:"STORAGE_ACCESS_DENIED",STORAGE_CORRUPTED:"STORAGE_CORRUPTED",NETWORK_ERROR:"NETWORK_ERROR",SERVICE_WORKER_ERROR:"SERVICE_WORKER_ERROR",OFFLINE_MODE:"OFFLINE_MODE",DUPLICATE_RETURN:"DUPLICATE_RETURN",INVALID_UMBRELLA:"INVALID_UMBRELLA",STATION_FULL:"STATION_FULL",USER_NOT_FOUND:"USER_NOT_FOUND",UNKNOWN_ERROR:"UNKNOWN_ERROR",PERMISSION_DENIED:"PERMISSION_DENIED"},r={[s.CAMERA_ACCESS_DENIED]:{code:s.CAMERA_ACCESS_DENIED,message:"Camera access denied by user",userMessage:"カメラへのアクセスが拒否されました。ブラウザの設定でカメラ使用を許可してください。",recoverable:!0,fallback:()=>console.log("Fallback: Show manual QR input")},[s.CAMERA_NOT_AVAILABLE]:{code:s.CAMERA_NOT_AVAILABLE,message:"Camera not available on this device",userMessage:"カメラが利用できません。手動入力をご利用ください。",recoverable:!0,fallback:()=>console.log("Fallback: Enable manual input mode")},[s.CAMERA_HARDWARE_ERROR]:{code:s.CAMERA_HARDWARE_ERROR,message:"Camera hardware error",userMessage:"カメラに問題が発生しました。デバイスを再起動するか、手動入力をお試しください。",recoverable:!0,fallback:()=>console.log("Fallback: Switch to manual input")},[s.QR_SCAN_FAILED]:{code:s.QR_SCAN_FAILED,message:"QR code scanning failed",userMessage:"QRコードの読み取りに失敗しました。明るい場所で再度お試しください。",recoverable:!0,fallback:()=>console.log("Fallback: Retry scan or manual input")},[s.STORAGE_QUOTA_EXCEEDED]:{code:s.STORAGE_QUOTA_EXCEEDED,message:"LocalStorage quota exceeded",userMessage:"データ保存領域がいっぱいです。ブラウザのキャッシュをクリアしてください。",recoverable:!0,fallback:()=>console.log("Fallback: Clear old data or show storage management")},[s.STORAGE_ACCESS_DENIED]:{code:s.STORAGE_ACCESS_DENIED,message:"LocalStorage access denied",userMessage:"データの保存ができません。プライベートブラウジングモードを無効にしてください。",recoverable:!0,fallback:()=>console.log("Fallback: Use session storage or memory storage")},[s.STORAGE_CORRUPTED]:{code:s.STORAGE_CORRUPTED,message:"Stored data is corrupted",userMessage:"データが破損しています。初期状態にリセットします。",recoverable:!0,fallback:()=>console.log("Fallback: Reset to default data")},[s.NETWORK_ERROR]:{code:s.NETWORK_ERROR,message:"Network connection error",userMessage:"インターネット接続がありません。オフラインモードで継続します。",recoverable:!0,fallback:()=>console.log("Fallback: Switch to offline mode")},[s.SERVICE_WORKER_ERROR]:{code:s.SERVICE_WORKER_ERROR,message:"Service Worker registration failed",userMessage:"オフライン機能の設定に失敗しました。ブラウザを再読み込みしてください。",recoverable:!0,fallback:()=>console.log("Fallback: Continue without offline features")},[s.OFFLINE_MODE]:{code:s.OFFLINE_MODE,message:"Application is in offline mode",userMessage:"オフラインモードです。一部の機能が制限されます。",recoverable:!0,fallback:()=>console.log("Fallback: Enable offline features")},[s.DUPLICATE_RETURN]:{code:s.DUPLICATE_RETURN,message:"Umbrella already returned",userMessage:"この傘はすでに返却されています。別の傘をお試しください。",recoverable:!0,fallback:()=>console.log("Fallback: Show available umbrellas")},[s.INVALID_UMBRELLA]:{code:s.INVALID_UMBRELLA,message:"Invalid umbrella ID",userMessage:"無効な傘IDです。正しいQRコードをスキャンしてください。",recoverable:!0,fallback:()=>console.log("Fallback: Retry scan")},[s.STATION_FULL]:{code:s.STATION_FULL,message:"Station at full capacity",userMessage:"このステーションは満杯です。近くの別のステーションをご利用ください。",recoverable:!0,fallback:()=>console.log("Fallback: Show nearby stations")},[s.USER_NOT_FOUND]:{code:s.USER_NOT_FOUND,message:"User not found",userMessage:"ユーザー情報が見つかりません。再度ログインしてください。",recoverable:!0,fallback:()=>console.log("Fallback: Redirect to login")},[s.UNKNOWN_ERROR]:{code:s.UNKNOWN_ERROR,message:"Unknown error occurred",userMessage:"予期しないエラーが発生しました。ページを再読み込みしてください。",recoverable:!0,fallback:()=>console.log("Fallback: Refresh page or reset state")},[s.PERMISSION_DENIED]:{code:s.PERMISSION_DENIED,message:"Permission denied",userMessage:"この操作の権限がありません。管理者にお問い合わせください。",recoverable:!1,fallback:()=>console.log("Fallback: Show contact information")}};class i{static handleCameraError(t){return"NotAllowedError"===t.name?r[s.CAMERA_ACCESS_DENIED]:"NotFoundError"===t.name?r[s.CAMERA_NOT_AVAILABLE]:"NotReadableError"===t.name?r[s.CAMERA_HARDWARE_ERROR]:r[s.QR_SCAN_FAILED]}static handleStorageError(t){var e;return"QuotaExceededError"===t.name?r[s.STORAGE_QUOTA_EXCEEDED]:(null==(e=t.message)?void 0:e.includes("Access denied"))?r[s.STORAGE_ACCESS_DENIED]:t instanceof SyntaxError?r[s.STORAGE_CORRUPTED]:r[s.UNKNOWN_ERROR]}static handleNetworkError(t){return navigator.onLine?r[s.NETWORK_ERROR]:r[s.OFFLINE_MODE]}static handleError(t,e){var a,i,n;return(console.error("Error in ".concat(e||"unknown context",":"),t),(null==(a=t.name)?void 0:a.includes("Camera"))||(null==(i=t.name)?void 0:i.includes("media")))?this.handleCameraError(t):(null==(n=t.message)?void 0:n.includes("localStorage"))||"QuotaExceededError"===t.name?this.handleStorageError(t):"NetworkError"!==t.name&&navigator.onLine?r[s.UNKNOWN_ERROR]:this.handleNetworkError(t)}static recover(t){if(t.recoverable&&t.fallback)try{t.fallback()}catch(t){console.error("Error in recovery action:",t)}}static getUserMessage(t){var e;return(null==(e=r[t])?void 0:e.userMessage)||r[s.UNKNOWN_ERROR].userMessage}static isRecoverable(t){var e,a;return null!=(a=null==(e=r[t])?void 0:e.recoverable)&&a}}function n(t,e,a){return function(){for(var s=arguments.length,r=Array(s),n=0;n<s;n++)r[n]=arguments[n];try{return t(...r)}catch(s){let t=i.handleError(s,e);return a?a(t):console.warn("Error in ".concat(e,":"),t.userMessage),i.recover(t),null}}}function o(t,e,a){return async function(){for(var s=arguments.length,r=Array(s),n=0;n<s;n++)r[n]=arguments[n];try{return await t(...r)}catch(s){let t=i.handleError(s,e);return a?a(t):console.warn("Error in ".concat(e,":"),t.userMessage),i.recover(t),null}}}function l(t,e,a){return null==t?(console.warn("Data is null/undefined, using default value"),e):a&&!a(t)?(console.warn("Data validation failed, using default value"),e):t}class c{static get(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return n(()=>{let a=localStorage.getItem(t);return a?JSON.parse(a):e},"SafeStorage.get(".concat(t,")"),t=>console.warn("Failed to read from storage: ".concat(t.userMessage)))()}static set(t,e){return null!==n(()=>(localStorage.setItem(t,JSON.stringify(e)),!0),"SafeStorage.set(".concat(t,")"),t=>console.warn("Failed to write to storage: ".concat(t.userMessage)))()}static remove(t){return null!==n(()=>(localStorage.removeItem(t),!0),"SafeStorage.remove(".concat(t,")"),t=>console.warn("Failed to remove from storage: ".concat(t.userMessage)))()}static clear(){return null!==n(()=>(localStorage.clear(),!0),"SafeStorage.clear()",t=>console.warn("Failed to clear storage: ".concat(t.userMessage)))()}}}}]);